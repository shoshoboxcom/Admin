<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>MM2 Admin</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@400;700;800&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0a0f;
    --surface: #13131a;
    --border: #1e1e2e;
    --accent: #9403fc;
    --accent2: #ff3c78;
    --text: #e8e8f0;
    --muted: #555570;
    --green: #00e87a;
    --red: #ff3c78;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

  body {
    font-family: 'Space Mono', monospace;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* ===== LOGIN ===== */
  #login-screen {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    padding: 16px;
  }

  .login-box {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 40px 32px;
    width: 100%;
    max-width: 360px;
    text-align: center;
  }

  .login-logo {
    font-family: 'Syne', sans-serif;
    font-size: 28px;
    font-weight: 800;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    margin-bottom: 6px;
  }

  .login-sub { color: var(--muted); font-size: 11px; margin-bottom: 32px; letter-spacing: 2px; }

  .login-input {
    width: 100%;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 14px 16px;
    color: var(--text);
    font-family: 'Space Mono', monospace;
    font-size: 16px; /* 16px —á—Ç–æ–±—ã iOS –Ω–µ –∑—É–º–∏–ª */
    margin-bottom: 14px;
    outline: none;
    text-align: center;
    letter-spacing: 3px;
    transition: border-color 0.2s;
  }
  .login-input:focus { border-color: var(--accent); }

  .login-btn {
    width: 100%;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    border: none;
    border-radius: 10px;
    padding: 15px;
    color: #fff;
    font-family: 'Syne', sans-serif;
    font-weight: 700;
    font-size: 14px;
    letter-spacing: 2px;
    cursor: pointer;
    transition: opacity 0.2s;
  }
  .login-btn:active { opacity: 0.8; }
  .login-error { color: var(--red); font-size: 12px; margin-top: 12px; display: none; }

  /* ===== MAIN ===== */
  #main-panel { display: none; }

  header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 14px 16px;
    border-bottom: 1px solid var(--border);
    background: var(--surface);
    position: sticky;
    top: 0;
    z-index: 200;
    gap: 10px;
  }

  .header-left {
    font-family: 'Syne', sans-serif;
    font-weight: 800;
    font-size: 17px;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    white-space: nowrap;
  }

  .header-right { display: flex; align-items: center; gap: 8px; flex-shrink: 0; }

  .save-btn {
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    border: none;
    border-radius: 8px;
    padding: 9px 16px;
    color: #fff;
    font-family: 'Syne', sans-serif;
    font-weight: 700;
    font-size: 12px;
    letter-spacing: 1px;
    cursor: pointer;
    white-space: nowrap;
    transition: opacity 0.2s;
  }
  .save-btn:active { opacity: 0.8; }
  .save-btn:disabled { opacity: 0.4; cursor: not-allowed; }

  .logout-btn {
    background: transparent;
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 9px 12px;
    color: var(--muted);
    font-family: 'Space Mono', monospace;
    font-size: 11px;
    cursor: pointer;
    white-space: nowrap;
    transition: all 0.2s;
  }
  .logout-btn:active { border-color: var(--red); color: var(--red); }

  /* STATUS */
  .status-bar {
    padding: 10px 16px;
    font-size: 12px;
    text-align: center;
    display: none;
  }
  .status-bar.success { background: rgba(0,232,122,0.1); color: var(--green); border-bottom: 1px solid rgba(0,232,122,0.15); }
  .status-bar.error { background: rgba(255,60,120,0.1); color: var(--red); border-bottom: 1px solid rgba(255,60,120,0.15); }
  .status-bar.loading { background: rgba(148,3,252,0.1); color: var(--accent); border-bottom: 1px solid rgba(148,3,252,0.15); }
  .status-bar.show { display: block; }

  .container { padding: 16px; max-width: 900px; margin: 0 auto; }

  /* STATS */
  .stats-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px; }

  .stat-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 14px 8px;
    text-align: center;
  }

  .stat-num { font-family: 'Syne', sans-serif; font-size: 26px; font-weight: 800; line-height: 1; margin-bottom: 4px; }
  .stat-num.green { color: var(--green); }
  .stat-num.red { color: var(--red); }
  .stat-num.purple { background: linear-gradient(135deg, var(--accent), var(--accent2)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
  .stat-label { color: var(--muted); font-size: 9px; letter-spacing: 1px; }

  /* TOOLBAR */
  .toolbar { display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; }

  .search-box {
    flex: 1;
    min-width: 140px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 10px 14px;
    color: var(--text);
    font-family: 'Space Mono', monospace;
    font-size: 14px;
    outline: none;
  }
  .search-box:focus { border-color: var(--accent); }

  .toolbar-btns { display: flex; gap: 8px; flex-wrap: wrap; }

  .chip {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 8px 14px;
    color: var(--muted);
    font-family: 'Space Mono', monospace;
    font-size: 11px;
    cursor: pointer;
    white-space: nowrap;
    transition: all 0.2s;
  }
  .chip:active, .chip.active { border-color: var(--accent); color: var(--accent); background: rgba(148,3,252,0.08); }
  .chip.green-chip:active { border-color: var(--green); color: var(--green); background: rgba(0,232,122,0.08); }
  .chip.red-chip:active { border-color: var(--red); color: var(--red); background: rgba(255,60,120,0.08); }

  /* PRODUCT GRID */
  .product-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 10px;
  }

  @media (min-width: 600px) {
    .product-grid { grid-template-columns: repeat(2, 1fr); }
  }

  @media (min-width: 900px) {
    .product-grid { grid-template-columns: repeat(3, 1fr); }
  }

  .product-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 12px;
    display: flex;
    flex-direction: column;
    gap: 10px;
    transition: border-color 0.2s;
  }
  .product-card.out { opacity: 0.5; }

  /* Card top row */
  .card-top { display: flex; align-items: center; gap: 10px; }

  .product-img {
    width: 54px;
    height: 54px;
    border-radius: 8px;
    object-fit: cover;
    flex-shrink: 0;
    background: var(--bg);
  }

  .product-info { flex: 1; min-width: 0; }

  .product-name-txt {
    font-family: 'Syne', sans-serif;
    font-weight: 700;
    font-size: 13px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    margin-bottom: 5px;
  }

  .badges { display: flex; gap: 4px; flex-wrap: wrap; align-items: center; }

  .badge { font-size: 8px; padding: 2px 6px; border-radius: 4px; font-weight: 700; letter-spacing: 0.5px; white-space: nowrap; }
  .badge-rarity-godly    { background: rgba(255,0,0,0.15);   color: #ff5555; }
  .badge-rarity-ancient  { background: rgba(98,0,255,0.15);  color: #9b6bff; }
  .badge-rarity-unique   { background: rgba(255,140,0,0.15); color: #ffb347; }
  .badge-rarity-legendary{ background: rgba(255,0,0,0.1);    color: #ff6666; }
  .badge-rarity-rare     { background: rgba(38,192,0,0.15);  color: #5dde5d; }
  .badge-rarity-uncommon { background: rgba(0,145,255,0.15); color: #5ab4ff; }
  .badge-rarity-common   { background: rgba(128,128,128,0.15);color: #aaa; }
  .badge-rarity-vintage  { background: rgba(255,204,0,0.15); color: #ffd740; }
  .badge-rarity-chroma   { background: rgba(255,60,120,0.15);color: var(--accent2); }
  .badge-cat  { background: rgba(148,3,252,0.15); color: #c060ff; }
  .badge-disc { background: rgba(255,215,0,0.15); color: #ffd740; border: 1px solid rgba(255,215,0,0.25); }

  .toggle-wrap { display: flex; flex-direction: column; align-items: center; gap: 3px; flex-shrink: 0; }
  .toggle { position: relative; width: 46px; height: 25px; cursor: pointer; }
  .toggle input { opacity: 0; width: 0; height: 0; }
  .slider { position: absolute; inset: 0; background: var(--border); border-radius: 25px; transition: 0.25s; }
  .slider::before { content: ''; position: absolute; width: 17px; height: 17px; left: 4px; bottom: 4px; background: var(--muted); border-radius: 50%; transition: 0.25s; }
  input:checked + .slider { background: rgba(0,232,122,0.2); border: 1px solid var(--green); }
  input:checked + .slider::before { transform: translateX(21px); background: var(--green); }
  .toggle-lbl { font-size: 8px; letter-spacing: 1px; font-weight: 700; }
  .toggle-lbl.in  { color: var(--green); }
  .toggle-lbl.out { color: var(--red); }

  /* SELECTORS ROW */
  .selectors-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 6px;
  }

  .sel-field label {
    display: block;
    font-size: 8px;
    color: var(--muted);
    letter-spacing: 1.5px;
    margin-bottom: 4px;
  }

  .sel-select {
    width: 100%;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 7px;
    padding: 8px 10px;
    color: var(--text);
    font-family: 'Space Mono', monospace;
    font-size: 11px;
    outline: none;
    cursor: pointer;
    transition: border-color 0.2s;
    appearance: none;
    -webkit-appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6' viewBox='0 0 10 6'%3E%3Cpath d='M1 1l4 4 4-4' stroke='%23555570' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 10px center;
    padding-right: 28px;
  }
  .sel-select:focus { border-color: var(--accent); }

  /* PRICE EDITOR */
  .price-editor {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 10px;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
  }

  .price-field label {
    display: block;
    font-size: 8px;
    color: var(--muted);
    letter-spacing: 1.5px;
    margin-bottom: 4px;
  }

  .price-input {
    width: 100%;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 8px 10px;
    color: var(--text);
    font-family: 'Space Mono', monospace;
    font-size: 13px;
    outline: none;
    transition: border-color 0.2s;
  }
  .price-input:focus { border-color: var(--accent); }

  .price-preview {
    font-size: 10px;
    color: var(--muted);
    grid-column: 1/-1;
    line-height: 1.6;
    padding-top: 2px;
  }
  .price-preview .pv  { color: var(--green); font-weight: 700; }
  .price-preview .po  { color: var(--red); text-decoration: line-through; }
  .price-preview .pd  { color: #ffd740; font-weight: 700; }
</style>
</head>
<body>

<!-- LOGIN -->
<div id="login-screen">
  <div class="login-box">
    <div class="login-logo">MM2 SHOP</div>
    <div class="login-sub">ADMIN PANEL</div>
    <input type="password" class="login-input" id="password-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
      onkeydown="if(event.key==='Enter')doLogin()">
    <button class="login-btn" onclick="doLogin()">–í–û–ô–¢–ò</button>
    <div class="login-error" id="login-error">–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å</div>
  </div>
</div>

<!-- MAIN -->
<div id="main-panel">
  <header>
    <div class="header-left">‚ö° MM2 ADMIN</div>
    <div class="header-right">
      <button class="save-btn" onclick="saveToJsonBin()" id="save-btn">üíæ –°–û–•–†–ê–ù–ò–¢–¨</button>
      <button class="logout-btn" onclick="doLogout()">–í–´–ô–¢–ò</button>
    </div>
  </header>

  <div class="status-bar" id="status-bar"></div>

  <div class="container">

    <!-- STATS -->
    <div class="stats-row">
      <div class="stat-card">
        <div class="stat-num purple" id="stat-total">0</div>
        <div class="stat-label">–¢–û–í–ê–†–û–í</div>
      </div>
      <div class="stat-card">
        <div class="stat-num green" id="stat-in">0</div>
        <div class="stat-label">–í –ù–ê–õ–ò–ß–ò–ò</div>
      </div>
      <div class="stat-card">
        <div class="stat-num red" id="stat-out">0</div>
        <div class="stat-label">–ù–ï–¢</div>
      </div>
    </div>

    <!-- TOOLBAR -->
    <div class="toolbar">
      <input class="search-box" id="admin-search" placeholder="üîç –ü–æ–∏—Å–∫..." oninput="renderProducts()">
      <div class="toolbar-btns">
        <button class="chip active" id="filter-all" onclick="setFilter('all')">–í–°–ï</button>
        <button class="chip" id="filter-in" onclick="setFilter('in')">–ï–°–¢–¨</button>
        <button class="chip" id="filter-out" onclick="setFilter('out')">–ù–ï–¢</button>
        <button class="chip green-chip" onclick="bulkSet(true)">‚úÖ –í–°–ï</button>
        <button class="chip red-chip" onclick="bulkSet(false)">‚ùå –£–ë–†–ê–¢–¨</button>
      </div>
    </div>

    <!-- PRODUCT GRID -->
    <div class="product-grid" id="admin-product-grid"></div>

  </div>
</div>

<script>
// ========= –ü–ê–†–û–õ–¨ =========
const ADMIN_PASSWORD = 'admin123';

// ========= JSONBIN =========
const JSONBIN_API_KEY = '$2a$10$aeI1awKXrn8g94Y10v5BUeP.zPPFcLoyrt0AgEuCTDBe7XBqSo.ne';
const JSONBIN_BIN_ID  = '6996ee4dd0ea881f40c692c7';

// ========= –¢–û–í–ê–†–´ =========
// –î–æ–±–∞–≤–ª—è–π —Ç–æ–≤–∞—Ä—ã —Å—é–¥–∞.
// price ‚Äî –∑–∞–ø–∞—Å–Ω–∞—è —Ü–µ–Ω–∞ (–µ—Å–ª–∏ JSONBin –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω).
// –í—Å–µ —Ü–µ–Ω—ã, —Å–∫–∏–¥–∫–∏, —Ä–µ–¥–∫–æ—Å—Ç—å, —Ç–∏–ø ‚Äî –º–µ–Ω—è—é—Ç—Å—è –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ.
const PRODUCTS = [
  {
    id: 'sweet',
    name: 'Sweet',
    category: 'knife',
    rarity: 'godly',
    weaponType: 'chroma',
    image: 'https://bit.ly/4aGGm5I',
    price: 1204,
  },
  // –î–æ–±–∞–≤–ª—è–π –Ω–æ–≤—ã–µ —Ç–æ–≤–∞—Ä—ã —Å—é–¥–∞ –ø–æ –æ–±—Ä–∞–∑—Ü—É
];

let stockData = {};
let currentFilter = 'all';

// –î–æ—Å—Ç—É–ø–Ω—ã–µ —Ä–µ–¥–∫–æ—Å—Ç–∏ –∏ —Ç–∏–ø—ã
const RARITIES = ['common','uncommon','rare','legendary','godly','ancient','vintage','chroma'];
const CATEGORIES = ['knife','gun'];

// ========= –†–ê–°–ß–Å–¢ –¶–ï–ù–´ +40% =========
function calcMarkup(base) {
  const p = base * 1.40;
  if (p < 10) return Math.ceil(p);
  if (p < 100) return Math.ceil(p / 5) * 5;
  if (p < 1000) {
    const last = Math.floor(p) % 10;
    const b = Math.floor(p / 10) * 10;
    if (last === 0) return b;
    else if (last <= 5) return b + 5;
    else return b + 10;
  }
  return Math.ceil(p / 10) * 10;
}

// ========= LOGIN =========
function doLogin() {
  const val = document.getElementById('password-input').value;
  if (val === ADMIN_PASSWORD) {
    document.getElementById('login-screen').style.display = 'none';
    document.getElementById('main-panel').style.display = 'block';
    loadFromJsonBin();
  } else {
    document.getElementById('login-error').style.display = 'block';
    document.getElementById('password-input').value = '';
  }
}

function doLogout() {
  document.getElementById('login-screen').style.display = 'flex';
  document.getElementById('main-panel').style.display = 'none';
  document.getElementById('password-input').value = '';
}

// ========= STATUS =========
function showStatus(msg, type) {
  const el = document.getElementById('status-bar');
  el.textContent = msg;
  el.className = 'status-bar show ' + type;
  if (type === 'success') setTimeout(() => el.classList.remove('show'), 3000);
}

// ========= JSONBIN =========
async function loadFromJsonBin() {
  showStatus('–ó–∞–≥—Ä—É–∑–∫–∞...', 'loading');
  try {
    const res = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}/latest`, {
      headers: { 'X-Master-Key': JSONBIN_API_KEY }
    });
    if (!res.ok) throw new Error('–û—à–∏–±–∫–∞ ' + res.status);
    const data = await res.json();
    stockData = data.record || {};
    showStatus('–ó–∞–≥—Ä—É–∂–µ–Ω–æ ‚úì', 'success');
  } catch (e) {
    showStatus('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + e.message, 'error');
  }
  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –Ω–æ–≤—ã–µ —Ç–æ–≤–∞—Ä—ã
  PRODUCTS.forEach(p => {
    if (!stockData[p.id]) {
      stockData[p.id] = {
        inStock: true,
        price: p.price,
        oldPrice: null,
        rarity: p.rarity || 'godly',
        category: p.category || 'knife',
        weaponType: p.weaponType || ''
      };
    }
  });
  renderProducts();
  updateStats();
}

async function saveToJsonBin() {
  const btn = document.getElementById('save-btn');
  btn.disabled = true;
  showStatus('–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...', 'loading');
  try {
    const res = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json', 'X-Master-Key': JSONBIN_API_KEY },
      body: JSON.stringify(stockData)
    });
    if (!res.ok) throw new Error('–û—à–∏–±–∫–∞ ' + res.status);
    showStatus('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ! –ú–∞–≥–∞–∑–∏–Ω –æ–±–Ω–æ–≤–ª—ë–Ω ‚úì', 'success');
  } catch (e) {
    showStatus('–û—à–∏–±–∫–∞: ' + e.message, 'error');
  }
  btn.disabled = false;
}

// ========= UI =========
function setFilter(f) {
  currentFilter = f;
  ['all','in','out'].forEach(x => {
    document.getElementById('filter-' + x).classList.toggle('active', x === f);
  });
  renderProducts();
}

function bulkSet(val) {
  const search = document.getElementById('admin-search').value.toLowerCase();
  PRODUCTS.forEach(p => {
    if (!search || p.name.toLowerCase().includes(search)) {
      if (stockData[p.id]) stockData[p.id].inStock = val;
    }
  });
  renderProducts();
  updateStats();
}

function toggle(id) {
  if (stockData[id]) stockData[id].inStock = !stockData[id].inStock;
  updateStats();
  const card = document.querySelector(`[data-id="${id}"]`);
  if (card) {
    const inStock = stockData[id].inStock;
    card.classList.toggle('out', !inStock);
    const inp = card.querySelector('input[type=checkbox]');
    if (inp) inp.checked = inStock;
    const lbl = card.querySelector('.toggle-lbl');
    if (lbl) { lbl.textContent = inStock ? '–ï–°–¢–¨' : '–ù–ï–¢'; lbl.className = 'toggle-lbl ' + (inStock ? 'in' : 'out'); }
  }
}

function updateField(id, field, value) {
  if (!stockData[id]) return;
  if (field === 'price' || field === 'oldPrice') {
    if (field === 'oldPrice' && (value === '' || value === '0')) {
      stockData[id].oldPrice = null;
    } else {
      const num = parseFloat(value);
      if (!isNaN(num) && num > 0) stockData[id][field] = num;
    }
    updatePricePreview(id);
  } else {
    stockData[id][field] = value;
    // –û–±–Ω–æ–≤–ª—è–µ–º –±–µ–π–¥–∂–∏ –≤ –∫–∞—Ä—Ç–æ—á–∫–µ
    updateBadges(id);
  }
}

function updateBadges(id) {
  const card = document.querySelector(`[data-id="${id}"]`);
  if (!card) return;
  const d = stockData[id];
  const badgesEl = card.querySelector('.badges');
  if (badgesEl) {
    const discPct = (d.oldPrice && d.oldPrice > d.price) ? Math.round((1 - d.price / d.oldPrice) * 100) : 0;
    badgesEl.innerHTML = buildBadges(d.rarity, d.category, d.weaponType, discPct);
  }
}

function buildBadges(rarity, category, weaponType, discPct) {
  let html = `<span class="badge badge-rarity-${rarity}">${rarity.toUpperCase()}</span>`;
  html += `<span class="badge badge-cat">${category.toUpperCase()}</span>`;
  if (weaponType === 'chroma') html += `<span class="badge badge-rarity-chroma">CHROMA</span>`;
  if (discPct > 0) html += `<span class="badge badge-disc">-${discPct}%</span>`;
  return html;
}

function updatePricePreview(id) {
  const preview = document.querySelector(`[data-id="${id}"] .price-preview`);
  if (!preview) return;
  const d = stockData[id];
  const price    = d.price    || 0;
  const oldPrice = d.oldPrice || null;
  const hasDisc  = oldPrice && oldPrice > price;

  if (hasDisc) {
    const disc = Math.round((1 - price / oldPrice) * 100);
    preview.innerHTML = `–ü–æ–∫—É–ø–∞—Ç–µ–ª—å: <span class="pv">${price}</span> <span class="po">${oldPrice}</span> <span class="pd">-${disc}%</span> <span style="color:#444">(–±–µ–∑ –Ω–∞—Ü–µ–Ω–∫–∏)</span>`;
    // –û–±–Ω–æ–≤–ª—è–µ–º –±–µ–π–¥–∂ —Å–∫–∏–¥–∫–∏
    updateBadges(id);
  } else {
    preview.innerHTML = `–ü–æ–∫—É–ø–∞—Ç–µ–ª—å: <span class="pv">${calcMarkup(price)}</span> <span style="color:#444">(+40% –æ—Ç ${price})</span>`;
    updateBadges(id);
  }
}

function updateStats() {
  const total = PRODUCTS.length;
  const inCount = PRODUCTS.filter(p => stockData[p.id] && stockData[p.id].inStock).length;
  document.getElementById('stat-total').textContent = total;
  document.getElementById('stat-in').textContent = inCount;
  document.getElementById('stat-out').textContent = total - inCount;
}

// –°—Ç—Ä–æ–∏–º –æ–ø—Ü–∏–∏ –¥–ª—è select
function rarityOptions(selected) {
  return RARITIES.map(r =>
    `<option value="${r}" ${r === selected ? 'selected' : ''}>${r.charAt(0).toUpperCase() + r.slice(1)}</option>`
  ).join('');
}

function categoryOptions(selected) {
  return CATEGORIES.map(c =>
    `<option value="${c}" ${c === selected ? 'selected' : ''}>${c.charAt(0).toUpperCase() + c.slice(1)}</option>`
  ).join('');
}

function renderProducts() {
  const search = document.getElementById('admin-search').value.toLowerCase();
  const grid   = document.getElementById('admin-product-grid');

  const filtered = PRODUCTS.filter(p => {
    const matchSearch = p.name.toLowerCase().includes(search);
    const inStock = stockData[p.id] && stockData[p.id].inStock;
    const matchFilter = currentFilter === 'all'
      || (currentFilter === 'in'  && inStock)
      || (currentFilter === 'out' && !inStock);
    return matchSearch && matchFilter;
  });

  grid.innerHTML = filtered.map(p => {
    const d = stockData[p.id] || { inStock: true, price: p.price, oldPrice: null, rarity: p.rarity, category: p.category, weaponType: p.weaponType || '' };
    const inStock   = d.inStock;
    const price     = d.price    ?? p.price;
    const oldPrice  = d.oldPrice || null;
    const rarity    = d.rarity   || p.rarity || 'godly';
    const category  = d.category || p.category || 'knife';
    const weaponType= d.weaponType !== undefined ? d.weaponType : (p.weaponType || '');
    const hasDisc   = oldPrice && oldPrice > price;
    const discPct   = hasDisc ? Math.round((1 - price / oldPrice) * 100) : 0;

    const previewHTML = hasDisc
      ? `–ü–æ–∫—É–ø–∞—Ç–µ–ª—å: <span class="pv">${price}</span> <span class="po">${oldPrice}</span> <span class="pd">-${discPct}%</span> <span style="color:#444">(–±–µ–∑ –Ω–∞—Ü–µ–Ω–∫–∏)</span>`
      : `–ü–æ–∫—É–ø–∞—Ç–µ–ª—å: <span class="pv">${calcMarkup(price)}</span> <span style="color:#444">(+40% –æ—Ç ${price})</span>`;

    return `
      <div class="product-card ${inStock ? '' : 'out'}" data-id="${p.id}">

        <div class="card-top">
          <img class="product-img" src="${p.image}" alt="${p.name}" loading="lazy" onerror="this.style.opacity=0.2">
          <div class="product-info">
            <div class="product-name-txt">${p.name}</div>
            <div class="badges">${buildBadges(rarity, category, weaponType, discPct)}</div>
          </div>
          <div class="toggle-wrap">
            <label class="toggle">
              <input type="checkbox" ${inStock ? 'checked' : ''} onchange="toggle('${p.id}')">
              <span class="slider"></span>
            </label>
            <span class="toggle-lbl ${inStock ? 'in' : 'out'}">${inStock ? '–ï–°–¢–¨' : '–ù–ï–¢'}</span>
          </div>
        </div>

        <div class="selectors-row">
          <div class="sel-field">
            <label>–¢–ò–ü –û–†–£–ñ–ò–Ø</label>
            <select class="sel-select" onchange="updateField('${p.id}', 'category', this.value)">
              ${categoryOptions(category)}
            </select>
          </div>
          <div class="sel-field">
            <label>–†–ï–î–ö–û–°–¢–¨</label>
            <select class="sel-select" onchange="updateField('${p.id}', 'rarity', this.value)">
              ${rarityOptions(rarity)}
            </select>
          </div>
        </div>

        <div class="price-editor">
          <div class="price-field">
            <label>–¶–ï–ù–ê (+40% –Ω–∞ —Å–∞–π—Ç–µ)</label>
            <input class="price-input" type="number" min="1" inputmode="numeric"
              value="${price}" onchange="updateField('${p.id}', 'price', this.value)">
          </div>
          <div class="price-field">
            <label>–°–¢–ê–†–ê–Ø –¶–ï–ù–ê (—Å–∫–∏–¥–∫–∞)</label>
            <input class="price-input" type="number" min="0" inputmode="numeric"
              value="${oldPrice ?? ''}" placeholder="–Ω–µ—Ç —Å–∫–∏–¥–∫–∏"
              onchange="updateField('${p.id}', 'oldPrice', this.value)">
          </div>
          <div class="price-preview">${previewHTML}</div>
        </div>

      </div>
    `;
  }).join('');
}

setFilter('all');
</script>
</body>
</html>
